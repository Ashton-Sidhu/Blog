<p>Jupyter Notebooks provide a great platform to produce human-readable documents containing code, equations, analysis their descriptions. Some consider it a powerful tool for development when combining it with NBDev. For such an integral tool, the out of the box start up is not the best.  Each use requires starting the Jupyter web application from the command line and entering your token or password. The entire web application relies on that terminal window being open. Some might “daemonize” the process and then use <a href="https://www.computerhope.com/unix/unohup.htm">nohup</a> to detach it from their terminal, but that’s not the most elegant and maintainable solution.</p>

<p>Lucky for us, Jupyter has already come up with a solution to this problem by coming out with an extension of Jupyter Notebooks that runs as a sustainable web application and has built in user authentication. To add a cherry on top it can be managed and sustained through Docker allowing for isolated development environments.</p>

<p>By the end of this post we will have a Jupyter Notebook instance which can be accessed on command without a terminal, from multiple devices within your network, and a much more user friendly authentication method.</p>

<h2 id="prerequisites">Prerequisites</h2>
<hr />
<p>The technical requirements are basic Docker and command line skills.</p>

<p>Regarding hardware, I recommend doing this on the most powerful device you have and one that is on for most of the day, preferably all day. One of the benefits of this setup is that you will be able to use the Jupyter Notebook from any device on your network, but have all the computation happen on the device we configure.</p>

<h2 id="what-is-jupyter-hub">What is Jupyter Hub</h2>
<hr />
<p>JupyterHub brings the power of notebooks to groups of users. The idea behind JupyterHub was to scale out the use of Jupyter Notebooks to enterprises, classrooms, and large groups of users. On the other hand, Jupyter Notebook is supposed to run in a local instance, on a single node, by a single developer. Unfortunately, there was no middle ground to have the usability and scalability of JupyterHub and the simplicity of running a local Jupyter Notebook. That is, until now.</p>

<p>JupyterHub has pre-built Docker images that we can utilize to spawn a single notebook on a whim, with little to no overhead in technical complexity. We are going to use the combination of Docker and JupyterHub to access Jupyter Notebooks from anytime, anywhere at the same URL.</p>

<h2 id="architecture">Architecture</h2>
<hr />
<p>At a high level the architecture is not complex and can even scale if you have more than one user you want to set this up for!</p>

<p>1) Type in the IP address or host name of the machine JupyterHub is running on.</p>

<p>2) Authenticate using username &amp; password</p>

<p>3) Start your server &amp; you’re good to go!</p>

<p><img src="/blog/images/jupyterhub/architecture.svg" alt="" /></p>

<h2 id="building-the-docker-images">Building the Docker Images</h2>
<hr />
<p>To build our at home JupyterHub server we will use the pre-built Docker images of JupyterHub &amp; JupyterLab.</p>

<h3 id="jupyterhub">JupyterHub</h3>

<h4 id="docker">Docker</h4>

<p>The JupyterHub Docker image is simple.</p>

<pre><code class="language-Dockerfile">FROM jupyterhub/jupyterhub:1.2

# Copy the JupyterHub configuration in the container
COPY jupyterhub_config.py .

# Download script to automatically stop idle single-user servers
COPY cull_idle_servers.py .

# Install dependencies (for advanced authentication and spawning)
RUN pip install dockerspawner
</code></pre>

<p>We use the pre-built JupyterHub Docker Image but then add our own configuration file along side code to stop idle servers, <code class="language-plaintext highlighter-rouge">cull_idle_servers.py</code>. Lastly, we install additional packages to spawn JupyterLab instances via Docker.</p>

<h4 id="docker-compose">Docker Compose</h4>

<p>To bring everything together, let’s create a <code class="language-plaintext highlighter-rouge">docker-compose</code> file to define our deployments and configuration.</p>

<pre><code class="language-Dockerfile">version: '3'

services:
  # Configuration for Hub+Proxy
  jupyterhub:
    build: .                # Build the container from this folder.
    container_name: jupyterhub_hub   # The service will use this container name.
    volumes:                         # Give access to Docker socket.
      - /var/run/docker.sock:/var/run/docker.sock
      - jupyterhub_data:/srv/jupyterlab
    environment:                     # Env variables passed to the Hub process.
      DOCKER_JUPYTER_IMAGE: jupyter/tensorflow-notebook
      DOCKER_NETWORK_NAME: ${COMPOSE_PROJECT_NAME}_default
      HUB_IP: jupyterhub_hub
    ports:
      - 8080:8080
    restart: unless-stopped

  # Configuration for the single-user servers
  jupyterlab:
    image: jupyter/tensorflow-notebook
    command: echo

volumes:
  jupyterhub_data:
</code></pre>

<p>The key environment variable to note is the <code class="language-plaintext highlighter-rouge">DOCKER_JUPYTER_IMAGE</code>. This is the Jupyter environment that will be spun up every time we access the server.</p>

<p>For more information on selecting Jupyter images you can visit the following Jupyter <a href="https://jupyter-docker-stacks.readthedocs.io/en/latest/using/selecting.html">documentation</a>.</p>

<h4 id="stopping-idle-servers">Stopping Idle Servers</h4>

<p>Since this is our home setup, we want to be able to stop idle instances to preserve memory on our machine. JupyterHub has services that can run along side itself and one of them is <a href="https://github.com/jupyterhub/jupyterhub-idle-culler">jupyterhub-idle-culler</a>. This service stops any instances that are idle for a prolonged duration.</p>

<p>Create a new file called <code class="language-plaintext highlighter-rouge">cull_idle_servers.py</code> and copy the contents of this file from the <a href="https://raw.githubusercontent.com/jupyterhub/jupyterhub-idle-culler/master/jupyterhub_idle_culler/__init__.py">jupyterhub-idle-culler project</a> into it.</p>

<div class="Toast">
   <span class="Toast-icon"><svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg></span>
   <span class="Toast-content">Ensure `cull_idle_servers.py` is in the same folder as the Dockerfile.</span>
</div>

<p>To find out more about services, JupyterHub has official <a href="https://jupyterhub.readthedocs.io/en/stable/reference/services.html">documentation</a> on them.</p>

<h4 id="jupyterhub-config">Jupyterhub Config</h4>

<p>To finish off, we need to define configuration options for our JupyterHub instance. For example, volume mounts, Docker images, services, authentication, etc.</p>

<p>Below is a simple configuration I use that gets the job done.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">spawner_class</span> <span class="o">=</span> <span class="s">'dockerspawner.DockerSpawner'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'DOCKER_JUPYTER_IMAGE'</span><span class="p">]</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">network_name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'DOCKER_NETWORK_NAME'</span><span class="p">]</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">hub_connect_ip</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'HUB_IP'</span><span class="p">]</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">hub_ip</span> <span class="o">=</span> <span class="s">"0.0.0.0"</span> <span class="c1"># Makes it accessible from anywhere on your network
</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">admin_access</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s">'name'</span><span class="p">:</span> <span class="s">'cull_idle'</span><span class="p">,</span>
        <span class="s">'admin'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">'command'</span><span class="p">:</span> <span class="p">[</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">'cull_idle_servers.py'</span><span class="p">,</span> <span class="s">'--timeout=42000'</span><span class="p">]</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="n">c</span><span class="p">.</span><span class="n">Spawner</span><span class="p">.</span><span class="n">default_url</span> <span class="o">=</span> <span class="s">'/lab'</span>

<span class="n">notebook_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'DOCKER_NOTEBOOK_DIR'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'/home/jovyan/work'</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="n">notebook_dir</span>
<span class="n">c</span><span class="p">.</span><span class="n">DockerSpawner</span><span class="p">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'/home/sidhu'</span><span class="p">:</span> <span class="s">'/home/jovyan/work'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The configuration options you want to take note of and change are the following:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">'command': [sys.executable, 'cull_idle_servers.py', '--timeout=42000']</code> : Timeout is the number of seconds until an idle Jupyter instance is shut down.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">c.Spawner.default_url = '/lab'</code>: Uses Jupyterlab instead of Jupyter Notebook. Comment out this line to use Jupyter Notebook.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">'/home/sidhu': '/home/jovyan/work'</code>: I mounted my home directory to the Jupyter home directory to have access to any projects and notebooks I have on my Desktop already. This also allows us to achieve persistence in the case we create new notebooks, they are saved to our local machine and will not get deleted if our Jupyter Notebook Docker container deleted. <strong>Remove this line if you do not wish to mount your home directory and do not forget to change <code class="language-plaintext highlighter-rouge">sidhu</code> to your user name</strong>.</p>
  </li>
</ul>

<h2 id="start-the-server">Start the Server</h2>
<hr />

<p>To start the server, simply run <code class="language-plaintext highlighter-rouge">docker-compose up -d</code> - navigate to <code class="language-plaintext highlighter-rouge">localhost:8080</code> in your browser and you should be able to see the JupyterHub landing page.</p>

<p><img src="/blog/images/jupyterhub/landingpage.png" alt="" /></p>

<p>To access it on other devices on your network - a laptop, an iPad, etc, first identify the IP of the host machine by running <code class="language-plaintext highlighter-rouge">ifconfig</code> on Unix machines &amp; <code class="language-plaintext highlighter-rouge">ipconfig</code> on windows.</p>

<p><img src="/blog/images/jupyterhub/ifconfig.png" alt="" /></p>

<p>From your other device, navigate to the IP you found on port 8080: <code class="language-plaintext highlighter-rouge">http://IP:8080</code> and you should see the JupyterHub landing page!</p>

<h3 id="authenticating">Authenticating</h3>

<p>That leaves us with the last task of authenticating to the server. Since we did not set up a LDAP server or OAuth, JupyterHub will use PAM (Pluggable Authentication Module) authentication to authenticate users. In English, JupyterHub uses the user name and passwords of of the host machine to authenticate. To make use of this, we are going to have to create a user on the JupyterLab Docker container. There are other ways of doing this such as having a script placed on the container and executed at container start up but we will do it manually as an exercise. It should be noted that if you tear down or rebuild the container that you will have to repeat this process, so an exercise to automate this process or switch to a different authentication method would be invaluable.</p>

<div class="Toast Toast--warning googoo" style="max-width: 1200px;">
   <span class="Toast-icon"><svg class="octicon octicon-alert octicon octicon-alert octicon octicon-alert octicon octicon-alert" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8.22 1.754a.25.25 0 00-.44 0L1.698 13.132a.25.25 0 00.22.368h12.164a.25.25 0 00.22-.368L8.22 1.754zm-1.763-.707c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0114.082 15H1.918a1.75 1.75 0 01-1.543-2.575L6.457 1.047zM9 11a1 1 0 11-2 0 1 1 0 012 0zm-.25-5.25a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5z"></path></svg></span>
   <span class="Toast-content">I do not recommend hard coding user credentials into any script or Dockerfile.</span>
</div>

<p>1) Find the JupyterLab container ID: <code class="language-plaintext highlighter-rouge">docker ps -a</code></p>

<p><img src="/blog/images/jupyterhub/containerid.png" alt="" /></p>

<p>2) “SSH” into the container: <code class="language-plaintext highlighter-rouge">docker exec -it $YOUR_CONTAINER_ID bash</code></p>

<p>3) Create a user and follow the terminal prompts to create a password: <code class="language-plaintext highlighter-rouge">useradd $YOUR_USERNAME</code></p>

<p>4) Sign in with the credentials and you’re all set!</p>

<p><img src="/blog/images/jupyterhub/jupyterlab.png" alt="" /></p>

<h2 id="feedback">Feedback</h2>
<hr />
<p>I encourage any and all feedback about any of my posts and tutorials. You can message me on <a href="https://twitter.com/ashtonasidhu">twitter</a> or e-mail me at sidhuashton@gmail.com.</p>
